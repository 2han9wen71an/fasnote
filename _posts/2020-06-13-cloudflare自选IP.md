---
layout: post
title: cloudflare自选IP
date: 2020-06-13 15:56:49
updated: 2020-06-13 15:56:49
status: publish
author: zhangwentian
categories: 
  - 代码笔记
tags: 
  - cloudflare
---


什么是自选IP
-------

早期的时候就在思考，如果套上cf之后能自选ip，那么多好啊？特别是这些香港的ip。果不其然，这不是就发现真有大佬，利用CF partner设置了自选ip

原理
--

先说原理，这是很多人不明白的根本。

> 浏览器-Dnspod解析-分线路解析-自选ip-CFAnycast内部网络-源IP

这里实际上利用了CF Anycast的一个特性，就是在任意一个边缘节点上，可以和边缘出口互通。

本来CF是自动分配边缘节点，从自动分配的边缘节点在连接到源站ip，但是期间经过多少跳转不得而知。这里就是强制解析到自选ip，利用这个特点回源。

配置
--

### 回源

找一个CF partner配置，这里A记录解析到源站IP，就是设置回源。
[![chrome_2018-12-07_09-21-05-1-1-1.png](https://imgki.anyni.com/usr/uploads/2019/03/955248415.png "chrome_2018-12-07_09-21-05-1-1-1.png")](https://imgki.anyni.com/usr/uploads/2019/03/955248415.png)

之后面板会自动跳出CNAME地址，只有在partner这个面板中才会有cname

[![chrome_2018-12-07_09-22-29-1-1-1.png](https://imgki.anyni.com/usr/uploads/2019/03/3624848511.png "chrome_2018-12-07_09-22-29-1-1-1.png")](https://imgki.anyni.com/usr/uploads/2019/03/3624848511.png)

### 分线路解析

去Dnspod分线路解析，其中要有默认的ip地址。

境外：CNAME解析到上面的CNAME地市

默认：A记录到加速IP

移动/联通/电信分别设置加速IP

[![chrome_2018-12-07_09-23-15-1-1-1.png](https://imgki.anyni.com/usr/uploads/2019/03/2978897065.png "chrome_2018-12-07_09-23-15-1-1-1.png")](https://imgki.anyni.com/usr/uploads/2019/03/2978897065.png)

效果还有的

[![chrome_2018-12-07_09-28-12-1-1.png](https://imgki.anyni.com/usr/uploads/2019/03/624592442.png "chrome_2018-12-07_09-28-12-1-1.png")](https://imgki.anyni.com/usr/uploads/2019/03/624592442.png)

加速IP
----

我也没有什么扫描的方法，ip都是来源于网上的大佬

```
104.18.62.1/24 香港hkix.net
104.16.35.1/24 香港hkix.net
104.16.36.1/24 香港hkix.net
104.18.35.1/24 香港hkix.net
104.18.36.1/24 香港hkix.net
104.16.54.1/24 香港
104.16.55.1/24 香港
104.18.128.1/24 香港
104.18.129.1/24 香港
104.18.130.1/24 香港
104.18.131.1/24 香港
104.18.132.1/24 香港
104.19.195.1/24 香港
104.19.196.1/24 香港
104.19.197.1/24 香港
104.19.198.1/24 香港
104.19.199.1/24 香港
```

* * * * *

2018.12.16增加两个ip

新加坡-联通 104.28.12.1/24

日本-移动 104.20.157.1/24

* * * * *

2019.3.1更新

实际上，通过最近一段时间来看，这样做也就是ping延迟低了，带宽没有太大提升。

* * * * *

2019.5.2更新

### 电信

大多数省直接使用1.0.0.0即可，延迟低，丢包少，
少部分还是需要换ip
新加坡
172.64.32.0-172.64.47.254

### 移动

新加坡
104.18.48.0-104.18.63.255
104.24.112.0-104.24.127.255
104.27.128.0-104.27.143.255
104.28.0.0-104.28.15.255

圣何塞 cogentco.com
104.28.16.0-31.255
104.27.144.0-243.254
104.23.240.0-243.254

香港cloudflare1-100g.hkix.net
大部分都是这个通道
1.0.0.0-254
1.1.1.0-254
66.235.200.0-254 此段为IPOWER.COM endurance.com专用，有可能被跳转到IPOWER.COM endurance.com页面
104.16.80.0-95.255
104.16.175.255-104.16.191.255

香港直连
23.227.63.0-254 此段为shopify.com专用，有可能被跳转到shopify.com页面
104.16.0.0-79.255
104.16.96.0-175.254
104.16.192.0-207.255

新加坡 ae-0.cloudflare.sngpsi07.sg.bb.gin.ntt.net
都从香港ntt转发
104.28.0.0-15.255

### 联通

172.64.19.16