---
layout: post
title: Tomcat 在 SpringBoot 中是如何启动的
date: 2020-01-01 14:37:00
updated: 2020-02-29 16:50:29
status: publish
author: zhangwentian
categories: 
  - 代码笔记
tags: 
  - JAVA
---


<h1 style="font-weight: bold;color: black;font-size: 28px;text-align: center;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfe6lic316L7synwibBzOufLbT1zbG5jtZuTz6QQZy0xfSXBb5efEazbKjwBGutgD6NYX1TDHrfomLOw/640?wx_fmt=png&quot;);background-position: center top;background-repeat: no-repeat;background-size: 95px;line-height: 95px;margin-top: 38px;margin-bottom: 10px;">
<span style="color: rgb(60, 112, 198);border-bottom: 2px solid #3C7076;">前言</span></h1><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">我们知道 SpringBoot 给我们带来了一个全新的开发体验，我们可以直接把 web 程序达成 jar 包，直接启动，这就得益于 SpringBoot 内置了容器，可以直接启动，本文将以 Tomcat 为例，来看看 SpringBoot 是如何启动 Tomcat 的，同时也将展开学习下 Tomcat 的源码，了解 Tomcat 的设计。</p><h1 style="font-weight: bold;color: black;font-size: 28px;text-align: center;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfe6lic316L7synwibBzOufLbT1zbG5jtZuTz6QQZy0xfSXBb5efEazbKjwBGutgD6NYX1TDHrfomLOw/640?wx_fmt=png&quot;);background-position: center top;background-repeat: no-repeat;background-size: 95px;line-height: 95px;margin-top: 38px;margin-bottom: 10px;"><span style="color: rgb(60, 112, 198);border-bottom: 2px solid #3C7076;">从 Main 方法说起</span></h1><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">用过 SpringBoot 的人都知道，首先要写一个 main 方法来启动</p><pre class="custom" style="margin-top: 10px;margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto;padding: 16px;background: #272822;color: #ddd;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;display: -webkit-box !important;"><span class="hljs-meta" style="color: #75715e;line-height: 26px;">@SpringBootApplication</span><br  /><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">class</span> <span class="hljs-title" style="font-weight: bold;color: white;line-height: 26px;">TomcatdebugApplication</span> </span>{<br  /><br  />    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">static</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">void</span> <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">main</span><span class="hljs-params" style="line-height: 26px;">(String[] args)</span> </span>{<br  />        SpringApplication.run(TomcatdebugApplication.class, args);<br  />    }<br  /><br  />}<br  /></code></pre><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">我们直接点击 run 方法的源码，跟踪下来，发下最终的 run 方法是调用 ConfigurableApplicationContext 方法，源码如下：</p><pre class="custom" style="margin-top: 10px;margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto;padding: 16px;background: #272822;color: #ddd;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;display: -webkit-box !important;"><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> ConfigurableApplicationContext <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">run</span><span class="hljs-params" style="line-height: 26px;">(String... args)</span> </span>{<br  />    StopWatch stopWatch = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> StopWatch();<br  />    stopWatch.start();<br  />    ConfigurableApplicationContext context = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">null</span>;<br  />    Collection&lt;springbootexceptionreporter&gt; exceptionReporters = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> ArrayList&amp;lt;&amp;gt;();<br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//设置系统属性『java.awt.headless』，为true则启用headless模式支持</span><br  />    configureHeadlessProperty();<br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//通过*SpringFactoriesLoader*检索*META-INF/spring.factories*，</span><br  />       <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//找到声明的所有SpringApplicationRunListener的实现类并将其实例化，</span><br  />       <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//之后逐个调用其started()方法，广播SpringBoot要开始执行了</span><br  />    SpringApplicationRunListeners listeners = getRunListeners(args);<br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//发布应用开始启动事件</span><br  />    listeners.starting();<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">try</span> {<br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//初始化参数</span><br  />      ApplicationArguments applicationArguments = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> DefaultApplicationArguments(args);<br  />      <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//创建并配置当前SpringBoot应用将要使用的Environment（包括配置要使用的PropertySource以及Profile）,</span><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//并遍历调用所有的SpringApplicationRunListener的environmentPrepared()方法，广播Environment准备完毕。</span><br  />      ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);<br  />      configureIgnoreBeanInfo(environment);<br  />      <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//打印banner</span><br  />      Banner printedBanner = printBanner(environment);<br  />      <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//创建应用上下文</span><br  />      context = createApplicationContext();<br  />      <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//通过*SpringFactoriesLoader*检索*META-INF/spring.factories*，获取并实例化异常分析器</span><br  />      exceptionReporters = getSpringFactoriesInstances(SpringBootExceptionReporter.class,<br  />          <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> Class[] { ConfigurableApplicationContext.class }, context);<br  />      <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//为ApplicationContext加载environment，之后逐个执行ApplicationContextInitializer的initialize()方法来进一步封装ApplicationContext，</span><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//并调用所有的SpringApplicationRunListener的contextPrepared()方法，【EventPublishingRunListener只提供了一个空的contextPrepared()方法】，</span><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//之后初始化IoC容器，并调用SpringApplicationRunListener的contextLoaded()方法，广播ApplicationContext的IoC加载完成，</span><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//这里就包括通过**@EnableAutoConfiguration**导入的各种自动配置类。</span><br  />      prepareContext(context, environment, listeners, applicationArguments, printedBanner);<br  />      <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//刷新上下文</span><br  />      refreshContext(context);<br  />      <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//再一次刷新上下文,其实是空方法，可能是为了后续扩展。</span><br  />      afterRefresh(context, applicationArguments);<br  />      stopWatch.stop();<br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (<span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">this</span>.logStartupInfo) {<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> StartupInfoLogger(<span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">this</span>.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);<br  />      }<br  />      <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//发布应用已经启动的事件</span><br  />      listeners.started(context);<br  />      <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//遍历所有注册的ApplicationRunner和CommandLineRunner，并执行其run()方法。</span><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//我们可以实现自己的ApplicationRunner或者CommandLineRunner，来对SpringBoot的启动过程进行扩展。</span><br  />      callRunners(context, applicationArguments);<br  />    }<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">catch</span> (Throwable ex) {<br  />      handleRunFailure(context, ex, exceptionReporters, listeners);<br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">throw</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> IllegalStateException(ex);<br  />    }<br  /><br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">try</span> {<br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//应用已经启动完成的监听事件</span><br  />      listeners.running(context);<br  />    }<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">catch</span> (Throwable ex) {<br  />      handleRunFailure(context, ex, exceptionReporters, <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">null</span>);<br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">throw</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> IllegalStateException(ex);<br  />    }<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">return</span> context;<br  />  }<br  /></code></pre><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">其实这个方法我们可以简单的总结下步骤为 &gt; 1. 配置属性 &gt; 2. 获取监听器，发布应用开始启动事件 &gt; 3. 初始化输入参数 &gt; 4. 配置环境，输出 banner &gt; 5. 创建上下文 &gt; 6. 预处理上下文 &gt; 7. 刷新上下文 &gt; 8. 再刷新上下文 &gt; 9. 发布应用已经启动事件 &gt; 10. 发布应用启动完成事件</p><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">其实上面这段代码，如果只要分析 tomcat 内容的话，只需要关注两个内容即可，上下文是如何创建的，上下文是如何刷新的，分别对应的方法就是 createApplicationContext() 和 refreshContext(context)，接下来我们来看看这两个方法做了什么。</p><pre class="custom" style="margin-top: 10px;margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto;padding: 16px;background: #272822;color: #ddd;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;display: -webkit-box !important;"><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">protected</span> ConfigurableApplicationContext <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">createApplicationContext</span><span class="hljs-params" style="line-height: 26px;">()</span> </span>{<br  />    Class&lt;!--?--&gt; contextClass = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">this</span>.applicationContextClass;<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (contextClass == <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">null</span>) {<br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">try</span> {<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">switch</span> (<span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">this</span>.webApplicationType) {<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">case</span> SERVLET:<br  />          contextClass = Class.forName(DEFAULT_SERVLET_WEB_CONTEXT_CLASS);<br  />          <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">break</span>;<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">case</span> REACTIVE:<br  />          contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS);<br  />          <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">break</span>;<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">default</span>:<br  />          contextClass = Class.forName(DEFAULT_CONTEXT_CLASS);<br  />        }<br  />      }<br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">catch</span> (ClassNotFoundException ex) {<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">throw</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> IllegalStateException(<br  />            <span class="hljs-string" style="color: #a6e22e;line-height: 26px;">"Unable create a default ApplicationContext, "</span> + <span class="hljs-string" style="color: #a6e22e;line-height: 26px;">"please specify an ApplicationContextClass"</span>,<br  />            ex);<br  />      }<br  />    }<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">return</span> (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass);<br  />  }<br  /></code></pre><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">这里就是根据我们的 webApplicationType 来判断创建哪种类型的 Servlet,代码中分别对应着 Web 类型(SERVLET),响应式 Web 类型（REACTIVE),非 Web 类型（default),我们建立的是 Web 类型，所以肯定实例化 DEFAULT_SERVLET_WEB_CONTEXT_CLASS 指定的类，也就是 AnnotationConfigServletWebServerApplicationContext 类，我们来用图来说明下这个类的关系</p><figure style="margin-top: 10px;margin-bottom: 10px;"><img class="" data-ratio="0.4935185185185185" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/JdLkEI9sZfe6lic316L7synwibBzOufLbTP7xTHsusZibuXwXMH0GoUAOytfUIBGgqLeO6EN1a81unaBA3hGsVWQQ/640?wx_fmt=jpeg" data-type="jpeg" data-w="1080" style="display: block;margin-right: auto;margin-left: auto;width: 100%;border-radius: 4px;margin-bottom: 25px;"  /></figure><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">通过这个类图我们可以知道，这个类继承的是 ServletWebServerApplicationContext,这就是我们真正的主角，而这个类最终是继承了 AbstractApplicationContext，了解完创建上下文的情况后，我们再来看看刷新上下文，相关代码如下：</p><pre class="custom" style="margin-top: 10px;margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto;padding: 16px;background: #272822;color: #ddd;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;display: -webkit-box !important;"><span class="hljs-comment" style="color: #75715e;line-height: 26px;">//类：SpringApplication.java</span><br  /><br  /><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">private</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">void</span> <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">refreshContext</span><span class="hljs-params" style="line-height: 26px;">(ConfigurableApplicationContext context)</span> </span>{<br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//直接调用刷新方法</span><br  />    refresh(context);<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (<span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">this</span>.registerShutdownHook) {<br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">try</span> {<br  />        context.registerShutdownHook();<br  />      }<br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">catch</span> (AccessControlException ex) {<br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Not allowed in some environments.</span><br  />      }<br  />    }<br  />  }<br  /><span class="hljs-comment" style="color: #75715e;line-height: 26px;">//类：SpringApplication.java</span><br  /><br  /><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">protected</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">void</span> <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">refresh</span><span class="hljs-params" style="line-height: 26px;">(ApplicationContext applicationContext)</span> </span>{<br  />    Assert.isInstanceOf(AbstractApplicationContext.class, applicationContext);<br  />    ((AbstractApplicationContext) applicationContext).refresh();<br  />  }<br  /></code></pre><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">这里还是直接传递调用本类的 refresh(context)方法，最后是强转成父类 AbstractApplicationContext 调用其 refresh()方法,该代码如下：</p><pre class="custom" style="margin-top: 10px;margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto;padding: 16px;background: #272822;color: #ddd;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;display: -webkit-box !important;"><span class="hljs-comment" style="color: #75715e;line-height: 26px;">// 类：AbstractApplicationContext</span><br  /><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">void</span> <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">refresh</span><span class="hljs-params" style="line-height: 26px;">()</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">throws</span> BeansException, IllegalStateException </span>{<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">synchronized</span> (<span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">this</span>.startupShutdownMonitor) {<br  />      <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Prepare this context for refreshing.</span><br  />      prepareRefresh();<br  /><br  />      <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Tell the subclass to refresh the internal bean factory.</span><br  />      ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();<br  /><br  />      <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Prepare the bean factory for use in this context.</span><br  />      prepareBeanFactory(beanFactory);<br  /><br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">try</span> {<br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Allows post-processing of the bean factory in context subclasses.</span><br  />        postProcessBeanFactory(beanFactory);<br  /><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Invoke factory processors registered as beans in the context.</span><br  />        invokeBeanFactoryPostProcessors(beanFactory);<br  /><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Register bean processors that intercept bean creation.</span><br  />        registerBeanPostProcessors(beanFactory);<br  /><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Initialize message source for this context.</span><br  />        initMessageSource();<br  /><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Initialize event multicaster for this context.</span><br  />        initApplicationEventMulticaster();<br  /><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Initialize other special beans in specific context subclasses.这里的意思就是调用各个子类的onRefresh()</span><br  />        onRefresh();<br  /><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Check for listener beans and register them.</span><br  />        registerListeners();<br  /><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Instantiate all remaining (non-lazy-init) singletons.</span><br  />        finishBeanFactoryInitialization(beanFactory);<br  /><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Last step: publish corresponding event.</span><br  />        finishRefresh();<br  />      }<br  /><br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">catch</span> (BeansException ex) {<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (logger.isWarnEnabled()) {<br  />          logger.warn(<span class="hljs-string" style="color: #a6e22e;line-height: 26px;">"Exception encountered during context initialization - "</span> +<br  />              <span class="hljs-string" style="color: #a6e22e;line-height: 26px;">"cancelling refresh attempt: "</span> + ex);<br  />        }<br  /><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Destroy already created singletons to avoid dangling resources.</span><br  />        destroyBeans();<br  /><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Reset 'active' flag.</span><br  />        cancelRefresh(ex);<br  /><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Propagate exception to caller.</span><br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">throw</span> ex;<br  />      }<br  /><br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">finally</span> {<br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Reset common introspection caches in Spring's core, since we</span><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// might not ever need metadata for singleton beans anymore...</span><br  />        resetCommonCaches();<br  />      }<br  />    }<br  />  }<br  /></code></pre><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">这里我们看到 onRefresh()方法是调用其子类的实现，根据我们上文的分析，我们这里的子类是 ServletWebServerApplicationContext。</p><pre class="custom" style="margin-top: 10px;margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto;padding: 16px;background: #272822;color: #ddd;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;display: -webkit-box !important;"><span class="hljs-comment" style="color: #75715e;line-height: 26px;">//类：ServletWebServerApplicationContext</span><br  /><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">protected</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">void</span> <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">onRefresh</span><span class="hljs-params" style="line-height: 26px;">()</span> </span>{<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">super</span>.onRefresh();<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">try</span> {<br  />      createWebServer();<br  />    }<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">catch</span> (Throwable ex) {<br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">throw</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> ApplicationContextException(<span class="hljs-string" style="color: #a6e22e;line-height: 26px;">"Unable to start web server"</span>, ex);<br  />    }<br  />  }<br  /><br  /><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">private</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">void</span> <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">createWebServer</span><span class="hljs-params" style="line-height: 26px;">()</span> </span>{<br  />    WebServer webServer = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">this</span>.webServer;<br  />    ServletContext servletContext = getServletContext();<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (webServer == <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">null</span> &amp;amp;&amp;amp; servletContext == <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">null</span>) {<br  />      ServletWebServerFactory factory = getWebServerFactory();<br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">this</span>.webServer = factory.getWebServer(getSelfInitializer());<br  />    }<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">else</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (servletContext != <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">null</span>) {<br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">try</span> {<br  />        getSelfInitializer().onStartup(servletContext);<br  />      }<br  />      <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">catch</span> (ServletException ex) {<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">throw</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> ApplicationContextException(<span class="hljs-string" style="color: #a6e22e;line-height: 26px;">"Cannot initialize servlet context"</span>, ex);<br  />      }<br  />    }<br  />    initPropertySources();<br  />  }<br  /></code></pre><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">到这里，其实庐山真面目已经出来了，createWebServer()就是启动 web 服务，但是还没有真正启动 Tomcat，既然 webServer 是通过 ServletWebServerFactory 来获取的，我们就来看看这个工厂的真面目。</p><figure style="margin-top: 10px;margin-bottom: 10px;"><img class="" data-ratio="0.3425925925925926" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/JdLkEI9sZfe6lic316L7synwibBzOufLbTlgJMKtaFxdLDeXa84JTFwdlRW03ReBcIh0yNTp3jXqEdKVeqWFhN6Q/640?wx_fmt=jpeg" data-type="jpeg" data-w="1080" style="display: block;margin-right: auto;margin-left: auto;width: 100%;border-radius: 4px;margin-bottom: 25px;"  /></figure><h1 style="font-weight: bold;color: black;font-size: 28px;text-align: center;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfe6lic316L7synwibBzOufLbT1zbG5jtZuTz6QQZy0xfSXBb5efEazbKjwBGutgD6NYX1TDHrfomLOw/640?wx_fmt=png&quot;);background-position: center top;background-repeat: no-repeat;background-size: 95px;line-height: 95px;margin-top: 38px;margin-bottom: 10px;"><span style="color: rgb(60, 112, 198);border-bottom: 2px solid #3C7076;">走进 Tomcat 内部</span></h1><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">根据上图我们发现，工厂类是一个接口，各个具体服务的实现是由各个子类来实现的，所以我们就去看看 TomcatServletWebServerFactory.getWebServer()的实现。</p><pre class="custom" style="margin-top: 10px;margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto;padding: 16px;background: #272822;color: #ddd;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;display: -webkit-box !important;"><span class="hljs-meta" style="color: #75715e;line-height: 26px;">@Override</span><br  />  <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> WebServer <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">getWebServer</span><span class="hljs-params" style="line-height: 26px;">(ServletContextInitializer... initializers)</span> </span>{<br  />    Tomcat tomcat = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> Tomcat();<br  />    File baseDir = (<span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">this</span>.baseDirectory != <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">null</span>) ? <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">this</span>.baseDirectory : createTempDir(<span class="hljs-string" style="color: #a6e22e;line-height: 26px;">"tomcat"</span>);<br  />    tomcat.setBaseDir(baseDir.getAbsolutePath());<br  />    Connector connector = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> Connector(<span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">this</span>.protocol);<br  />    tomcat.getService().addConnector(connector);<br  />    customizeConnector(connector);<br  />    tomcat.setConnector(connector);<br  />    tomcat.getHost().setAutoDeploy(<span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">false</span>);<br  />    configureEngine(tomcat.getEngine());<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">for</span> (Connector additionalConnector : <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">this</span>.additionalTomcatConnectors) {<br  />      tomcat.getService().addConnector(additionalConnector);<br  />    }<br  />    prepareContext(tomcat.getHost(), initializers);<br  />    <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">return</span> getTomcatWebServer(tomcat);<br  />  }<br  /></code></pre><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">根据上面的代码，我们发现其主要做了两件事情，第一件事就是把 Connnctor(我们称之为连接器)对象添加到 Tomcat 中，第二件事就是 configureEngine,这连接器我们勉强能理解（不理解后面会述说），那这个 Engine 是什么呢？我们查看 tomcat.getEngine()的源码：</p><pre class="custom" style="margin-top: 10px;margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto;padding: 16px;background: #272822;color: #ddd;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;display: -webkit-box !important;"><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> Engine <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">getEngine</span><span class="hljs-params" style="line-height: 26px;">()</span> </span>{<br  />        Service service = getServer().findServices()[<span class="hljs-number" style="line-height: 26px;">0</span>];<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (service.getContainer() != <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">null</span>) {<br  />            <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">return</span> service.getContainer();<br  />        }<br  />        Engine engine = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> StandardEngine();<br  />        engine.setName( <span class="hljs-string" style="color: #a6e22e;line-height: 26px;">"Tomcat"</span> );<br  />        engine.setDefaultHost(hostname);<br  />        engine.setRealm(createDefaultRealm());<br  />        service.setContainer(engine);<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">return</span> engine;<br  />    }<br  /></code></pre><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">根据上面的源码，我们发现，原来这个 Engine 是容器，我们继续跟踪源码，找到 Container 接口</p><figure style="margin-top: 10px;margin-bottom: 10px;"><img class="" data-ratio="0.3861111111111111" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/JdLkEI9sZfe6lic316L7synwibBzOufLbTSu7udXx49HwHs69wazNNXkl6yv0zLlbExvslYibKiaibfUuKmCjymZGpA/640?wx_fmt=jpeg" data-type="jpeg" data-w="1080" style="display: block;margin-right: auto;margin-left: auto;width: 100%;border-radius: 4px;margin-bottom: 25px;"  /></figure><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">上图中，我们看到了 4 个子接口，分别是 Engine,Host,Context,Wrapper。我们从继承关系上可以知道他们都是容器，那么他们到底有啥区别呢？我看看他们的注释是怎么说的。</p><pre class="custom" style="margin-top: 10px;margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto;padding: 16px;background: #272822;color: #ddd;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;display: -webkit-box !important;"><span class="hljs-comment" style="color: #75715e;line-height: 26px;">/**<br  /> If used, an Engine is always the top level Container in a Catalina<br  /> * hierarchy. Therefore, the implementation's &lt;code&gt;setParent()&lt;/code&gt; method<br  /> * should throw &lt;code&gt;IllegalArgumentException&lt;/code&gt;.<br  /> *<br  /> * <span class="hljs-doctag" style="font-weight: bold;line-height: 26px;">@author</span> Craig R. McClanahan<br  /> */</span><br  /><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">interface</span> <span class="hljs-title" style="font-weight: bold;color: white;line-height: 26px;">Engine</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">extends</span> <span class="hljs-title" style="font-weight: bold;color: white;line-height: 26px;">Container</span> </span>{<br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//省略代码</span><br  />}<br  /><span class="hljs-comment" style="color: #75715e;line-height: 26px;">/**<br  /> * &lt;p&gt;<br  /> * The parent Container attached to a Host is generally an Engine, but may<br  /> * be some other implementation, or may be omitted if it is not necessary.<br  /> * &lt;/p&gt;&lt;p&gt;<br  /> * The child containers attached to a Host are generally implementations<br  /> * of Context (representing an individual servlet context).<br  /> *<br  /> * <span class="hljs-doctag" style="font-weight: bold;line-height: 26px;">@author</span> Craig R. McClanahan<br  /> */</span><br  /><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">interface</span> <span class="hljs-title" style="font-weight: bold;color: white;line-height: 26px;">Host</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">extends</span> <span class="hljs-title" style="font-weight: bold;color: white;line-height: 26px;">Container</span> </span>{<br  /><span class="hljs-comment" style="color: #75715e;line-height: 26px;">//省略代码</span><br  /><br  />}<br  /><span class="hljs-comment" style="color: #75715e;line-height: 26px;">/*** &lt;/p&gt;&lt;p&gt;<br  /> * The parent Container attached to a Context is generally a Host, but may<br  /> * be some other implementation, or may be omitted if it is not necessary.<br  /> * &lt;/p&gt;&lt;p&gt;<br  /> * The child containers attached to a Context are generally implementations<br  /> * of Wrapper (representing individual servlet definitions).<br  /> * &lt;/p&gt;&lt;p&gt;<br  /> *<br  /> * <span class="hljs-doctag" style="font-weight: bold;line-height: 26px;">@author</span> Craig R. McClanahan<br  /> */</span><br  /><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">interface</span> <span class="hljs-title" style="font-weight: bold;color: white;line-height: 26px;">Context</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">extends</span> <span class="hljs-title" style="font-weight: bold;color: white;line-height: 26px;">Container</span>, <span class="hljs-title" style="font-weight: bold;color: white;line-height: 26px;">ContextBind</span> </span>{<br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//省略代码</span><br  />}<br  /><span class="hljs-comment" style="color: #75715e;line-height: 26px;">/**&lt;/p&gt;&lt;p&gt;<br  /> * The parent Container attached to a Wrapper will generally be an<br  /> * implementation of Context, representing the servlet context (and<br  /> * therefore the web application) within which this servlet executes.<br  /> * &lt;/p&gt;&lt;p&gt;<br  /> * Child Containers are not allowed on Wrapper implementations, so the<br  /> * &lt;code&gt;addChild()&lt;/code&gt; method should throw an<br  /> * &lt;code&gt;IllegalArgumentException&lt;/code&gt;.<br  /> *<br  /> * <span class="hljs-doctag" style="font-weight: bold;line-height: 26px;">@author</span> Craig R. McClanahan<br  /> */</span><br  /><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">interface</span> <span class="hljs-title" style="font-weight: bold;color: white;line-height: 26px;">Wrapper</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">extends</span> <span class="hljs-title" style="font-weight: bold;color: white;line-height: 26px;">Container</span> </span>{<br  /><br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//省略代码</span><br  />}<br  /></code></pre><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">上面的注释翻译过来就是，Engine 是最高级别的容器，其子容器是 Host,Host 的子容器是 Context,Wrapper 是 Context 的子容器，所以这 4 个容器的关系就是父子关系，也就是 Engine&gt;Host&gt;Context&gt;Wrapper。我们再看看 Tomcat 类的源码:</p><pre class="custom" style="margin-top: 10px;margin-bottom: 10px;"><code class="hljs" style="overflow-x: auto;padding: 16px;background: #272822;color: #ddd;font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;border-radius: 0px;font-size: 12px;-webkit-overflow-scrolling: touch;display: -webkit-box !important;"><span class="hljs-comment" style="color: #75715e;line-height: 26px;">//部分源码，其余部分省略。</span><br  /><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">class</span> <span class="hljs-title" style="font-weight: bold;color: white;line-height: 26px;">Tomcat</span> </span>{<br  /><span class="hljs-comment" style="color: #75715e;line-height: 26px;">//设置连接器</span><br  />     <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">void</span> <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">setConnector</span><span class="hljs-params" style="line-height: 26px;">(Connector connector)</span> </span>{<br  />        Service service = getService();<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">boolean</span> found = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">false</span>;<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">for</span> (Connector serviceConnector : service.findConnectors()) {<br  />            <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (connector == serviceConnector) {<br  />                found = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">true</span>;<br  />            }<br  />        }<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (!found) {<br  />            service.addConnector(connector);<br  />        }<br  />    }<br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//获取service</span><br  />       <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> Service <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">getService</span><span class="hljs-params" style="line-height: 26px;">()</span> </span>{<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">return</span> getServer().findServices()[<span class="hljs-number" style="line-height: 26px;">0</span>];<br  />    }<br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//设置Host容器</span><br  />     <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">void</span> <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">setHost</span><span class="hljs-params" style="line-height: 26px;">(Host host)</span> </span>{<br  />        Engine engine = getEngine();<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">boolean</span> found = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">false</span>;<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">for</span> (Container engineHost : engine.findChildren()) {<br  />            <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (engineHost == host) {<br  />                found = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">true</span>;<br  />            }<br  />        }<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (!found) {<br  />            engine.addChild(host);<br  />        }<br  />    }<br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//获取Engine容器</span><br  />     <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> Engine <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">getEngine</span><span class="hljs-params" style="line-height: 26px;">()</span> </span>{<br  />        Service service = getServer().findServices()[<span class="hljs-number" style="line-height: 26px;">0</span>];<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (service.getContainer() != <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">null</span>) {<br  />            <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">return</span> service.getContainer();<br  />        }<br  />        Engine engine = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> StandardEngine();<br  />        engine.setName( <span class="hljs-string" style="color: #a6e22e;line-height: 26px;">"Tomcat"</span> );<br  />        engine.setDefaultHost(hostname);<br  />        engine.setRealm(createDefaultRealm());<br  />        service.setContainer(engine);<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">return</span> engine;<br  />    }<br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//获取server</span><br  />       <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> Server <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">getServer</span><span class="hljs-params" style="line-height: 26px;">()</span> </span>{<br  /><br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (server != <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">null</span>) {<br  />            <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">return</span> server;<br  />        }<br  /><br  />        System.setProperty(<span class="hljs-string" style="color: #a6e22e;line-height: 26px;">"catalina.useNaming"</span>, <span class="hljs-string" style="color: #a6e22e;line-height: 26px;">"false"</span>);<br  /><br  />        server = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> StandardServer();<br  /><br  />        initBaseDir();<br  /><br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// Set configuration source</span><br  />        ConfigFileLoader.setSource(<span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> CatalinaBaseConfigurationSource(<span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> File(basedir), <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">null</span>));<br  /><br  />        server.setPort( -<span class="hljs-number" style="line-height: 26px;">1</span> );<br  /><br  />        Service service = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> StandardService();<br  />        service.setName(<span class="hljs-string" style="color: #a6e22e;line-height: 26px;">"Tomcat"</span>);<br  />        server.addService(service);<br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">return</span> server;<br  />    }<br  /><br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//添加Context容器</span><br  />      <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> Context <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">addContext</span><span class="hljs-params" style="line-height: 26px;">(Host host, String contextPath, String contextName,<br  />            String dir)</span> </span>{<br  />        silence(host, contextName);<br  />        Context ctx = createContext(host, contextPath);<br  />        ctx.setName(contextName);<br  />        ctx.setPath(contextPath);<br  />        ctx.setDocBase(dir);<br  />        ctx.addLifecycleListener(<span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> FixContextListener());<br  /><br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">if</span> (host == <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">null</span>) {<br  />            getHost().addChild(ctx);<br  />        } <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">else</span> {<br  />            host.addChild(ctx);<br  />        }<br  /><br  />    <span class="hljs-comment" style="color: #75715e;line-height: 26px;">//添加Wrapper容器</span><br  />         <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">static</span> Wrapper <span class="hljs-title" style="color: #a6e22e;font-weight: bold;line-height: 26px;">addServlet</span><span class="hljs-params" style="line-height: 26px;">(Context ctx,<br  />                                      String servletName,<br  />                                      Servlet servlet)</span> </span>{<br  />        <span class="hljs-comment" style="color: #75715e;line-height: 26px;">// will do class for name and set init params</span><br  />        Wrapper sw = <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">new</span> ExistingStandardWrapper(servlet);<br  />        sw.setName(servletName);<br  />        ctx.addChild(sw);<br  /><br  />        <span class="hljs-keyword" style="color: #f92672;font-weight: bold;line-height: 26px;">return</span> sw;<br  />    }<br  /><br  />}<br  /></code></pre><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">阅读 Tomcat 的 getServer()我们可以知道，Tomcat 的最顶层是 Server,Server 就是 Tomcat 的实例，一个 Tomcat 一个 Server;通过 getEngine()我们可以了解到 Server 下面是 Service，而且是多个，一个 Service 代表我们部署的一个应用，而且我们还可以知道，Engine 容器，一个 service 只有一个；根据父子关系，我们看 setHost()源码可以知道，host 容器有多个；同理，我们发现 addContext()源码下，Context 也是多个；addServlet()表明 Wrapper 容器也是多个，而且这段代码也暗示了，其实 Wrapper 和 Servlet 是一层意思。另外我们根据 setConnector 源码可以知道，连接器(Connector)是设置在 service 下的，而且是可以设置多个连接器(Connector)。</p><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">根据上面分析，我们可以小结下：Tomcat 主要包含了 2 个核心组件，连接器(Connector)和容器(Container),用图表示如下：</p><figure style="margin-top: 10px;margin-bottom: 10px;"><img class="" data-ratio="0.6605657237936772" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/JdLkEI9sZfe6lic316L7synwibBzOufLbTZfibwP1tnyBRtFrPn7OCwezJ1rQ18Dj6LSia0kqQHWBuT270wqJ3nZ1w/640?wx_fmt=jpeg" data-type="jpeg" data-w="601" style="display: block;margin-right: auto;margin-left: auto;width: 100%;border-radius: 4px;margin-bottom: 25px;"  /></figure><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">一个 Tomcat 是一个 Server,一个 Server 下有多个 service，也就是我们部署的多个应用，一个应用下有多个连接器(Connector)和一个容器（Container）,容器下有多个子容器，关系用图表示如下：</p><figure style="margin-top: 10px;margin-bottom: 10px;"><img class="" data-ratio="0.7335285505124451" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/JdLkEI9sZfe6lic316L7synwibBzOufLbTgRu3sMaxW5mzd6Yb1zJtP0icTl3p4vRepRWJw7dqWgBA5ic2lIw2qSqQ/640?wx_fmt=jpeg" data-type="jpeg" data-w="683" style="display: block;margin-right: auto;margin-left: auto;width: 100%;border-radius: 4px;margin-bottom: 25px;"  /></figure><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">Engine 下有多个 Host 子容器，Host 下有多个 Context 子容器，Context 下有多个 Wrapper 子容器。</p><h1 style="font-weight: bold;color: black;font-size: 28px;text-align: center;background-image: url(&quot;https://mmbiz.qpic.cn/mmbiz_png/JdLkEI9sZfe6lic316L7synwibBzOufLbT1zbG5jtZuTz6QQZy0xfSXBb5efEazbKjwBGutgD6NYX1TDHrfomLOw/640?wx_fmt=png&quot;);background-position: center top;background-repeat: no-repeat;background-size: 95px;line-height: 95px;margin-top: 38px;margin-bottom: 10px;"><span style="color: rgb(60, 112, 198);border-bottom: 2px solid #3C7076;">总结</span></h1><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">SpringBoot 的启动是通过 new SpringApplication()实例来启动的，启动过程主要做如下几件事情：&gt; 1. 配置属性 &gt; 2. 获取监听器，发布应用开始启动事件 &gt; 3. 初始化输入参数 &gt; 4. 配置环境，输出 banner &gt; 5. 创建上下文 &gt; 6. 预处理上下文 &gt; 7. 刷新上下文 &gt; 8. 再刷新上下文 &gt; 9. 发布应用已经启动事件 &gt; 10. 发布应用启动完成事件</p><p style="padding-bottom: 8px;padding-top: 23px;color: rgb(74, 74, 74);line-height: 1.75em;">而启动 Tomcat 就是在第 7 步中“刷新上下文”；Tomcat 的启动主要是初始化 2 个核心组件，连接器(Connector)和容器（Container），一个 Tomcat 实例就是一个 Server，一个 Server 包含多个 Service，也就是多个应用程序，每个 Service 包含多个连接器（Connetor）和一个容器（Container),而容器下又有多个子容器，按照父子关系分别为：Engine,Host,Context,Wrapper，其中除了 Engine 外，其余的容器都是可以有多个。